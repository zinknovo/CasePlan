<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Plan Workspace</title>
    <style>
        :root {
            --bg: #f4f4f4;
            --surface: #ffffff;
            --border: #d7d7d7;
            --text: #171717;
            --muted: #666666;
            --primary: #222222;
            --primary-hover: #000000;
            --danger: #222222;
            --danger-bg: #efefef;
            --success: #1f1f1f;
            --success-bg: #ececec;
            --warn: #3a3a3a;
            --warn-bg: #f1f1f1;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "IBM Plex Sans", "Segoe UI", Roboto, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.4;
        }
        .page {
            max-width: 1180px;
            margin: 24px auto;
            padding: 0 16px 24px;
        }
        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 1px rgba(16, 24, 32, 0.03);
        }
        .panel + .panel {
            margin-top: 16px;
        }
        .panel-title {
            margin: 0 0 14px;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.01em;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-grid .full {
            grid-column: 1 / -1;
        }
        label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
        }
        input, textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 9px 10px;
            font-size: 14px;
            color: var(--text);
            background: #fff;
        }
        textarea {
            min-height: 96px;
            resize: vertical;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #9a9a9a;
            box-shadow: 0 0 0 2px rgba(30, 30, 30, 0.12);
        }
        .toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 14px;
        }
        .btn {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: var(--primary);
            color: #fff;
        }
        .btn:hover {
            background: var(--primary-hover);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #fff;
            color: var(--text);
            border-color: var(--border);
        }
        .btn-secondary:hover {
            background: #f2f2f2;
        }
        .btn-danger {
            background: #fff;
            color: var(--danger);
            border-color: #d9b8b8;
        }
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 12px;
        }
        .hint {
            color: var(--muted);
            font-size: 12px;
        }
        .msg {
            margin: 0 0 10px;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid;
            font-size: 13px;
        }
        .msg.error {
            background: var(--danger-bg);
            border-color: #e8c4c4;
            color: var(--danger);
        }
        .msg.info {
            background: #f1f1f1;
            border-color: #d5d5d5;
            color: #2f2f2f;
        }
        .table-wrap {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 980px;
            background: #fff;
        }
        thead {
            background: #f8fafb;
        }
        th, td {
            border-bottom: 1px solid var(--border);
            text-align: left;
            padding: 10px 12px;
            vertical-align: top;
            font-size: 13px;
        }
        th {
            color: var(--muted);
            font-weight: 600;
        }
        tr:last-child td {
            border-bottom: 0;
        }
        .status {
            display: inline-block;
            border-radius: 999px;
            padding: 2px 9px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }
        .status.pending, .status.processing {
            color: #4a4a4a;
            background: #f3f3f3;
        }
        .status.completed {
            color: #242424;
            background: #e9e9e9;
        }
        .status.failed {
            color: #1f1f1f;
            background: #e2e2e2;
        }
        .row-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .empty {
            text-align: center;
            padding: 28px 10px;
            color: var(--muted);
            font-size: 13px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            background: #fff;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(8, 12, 16, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 20;
        }
        .modal {
            width: min(960px, 100%);
            max-height: 88vh;
            overflow: hidden;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .modal-title {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
        }
        .modal-body {
            padding: 14px;
            overflow: auto;
            background: #fbfcfd;
        }
        .modal-body pre {
            margin: 0;
            font-family: "IBM Plex Mono", Menlo, Consolas, monospace;
            font-size: 12px;
            line-height: 1.55;
            white-space: pre-wrap;
            word-break: break-word;
        }
        @media (max-width: 860px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .top-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .toolbar {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    const API_BASE = "https://mc94chabh2.execute-api.us-east-2.amazonaws.com";
    const ORDERS_BASE = API_BASE + "/orders";
    const POLL_MS = 5000;
    const EMPTY_FORM = {
        clientFirstName: "",
        clientLastName: "",
        clientIdNumber: "",
        attorneyName: "",
        barNumber: "",
        referringSource: "",
        caseNumber: "",
        primaryCauseOfAction: "",
        opposingParty: "",
        remedySought: "",
        additionalCauses: "",
        priorLegalActions: "",
        caseDocuments: ""
    };

    function App() {
        const [form, setForm] = useState(EMPTY_FORM);
        const [plans, setPlans] = useState([]);
        const [loading, setLoading] = useState(true);
        const [pendingCreates, setPendingCreates] = useState(0);
        const [error, setError] = useState("");
        const [info, setInfo] = useState("");
        const [modalPlan, setModalPlan] = useState(null);
        const [viewing, setViewing] = useState(false);

        async function fetchPlans(silent) {
            if (!silent) {
                setLoading(true);
            }
            try {
                const res = await fetch(ORDERS_BASE);
                if (!res.ok) {
                    throw new Error("Failed to load plans (" + res.status + ")");
                }
                const data = await res.json();
                const list = Array.isArray(data)
                    ? data
                    : Array.isArray(data && data.items)
                        ? data.items
                        : [];
                setPlans(list);
                if (!silent) {
                    setError("");
                }
            } catch (e) {
                setError(e.message || "Failed to load plans");
            } finally {
                if (!silent) {
                    setLoading(false);
                }
            }
        }

        useEffect(() => {
            fetchPlans(false);
            const timer = setInterval(() => {
                fetchPlans(true);
            }, POLL_MS);
            return () => clearInterval(timer);
        }, []);

        function updateField(key, value) {
            setForm(prev => ({ ...prev, [key]: value }));
        }

        async function handleSubmit(e) {
            e.preventDefault();
            setError("");
            const payload = { ...form };
            setForm(EMPTY_FORM);
            setPendingCreates(prev => prev + 1);
            setInfo("Submitting in background. You can enter the next case now.");

            (async () => {
                try {
                    const res = await fetch(ORDERS_BASE, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });
                    let body = null;
                    try {
                        body = await res.json();
                    } catch (ignore) {
                    }
                    if (!res.ok) {
                        const msg = body && body.message ? body.message : ("Create failed (" + res.status + ")");
                        throw new Error(msg);
                    }
                    const createdId = body && body.id ? body.id : null;
                    if (createdId) {
                        const queuedItem = {
                            id: createdId,
                            status: (body && body.status) || "pending",
                            createdAt: new Date().toISOString(),
                            caseInfo: {
                                caseNumber: payload.caseNumber || "",
                                primaryCauseOfAction: payload.primaryCauseOfAction || "",
                                remedySought: payload.remedySought || "",
                                client: {
                                    firstName: payload.clientFirstName || "",
                                    lastName: payload.clientLastName || ""
                                },
                                attorney: {
                                    name: payload.attorneyName || "",
                                    barNumber: payload.barNumber || ""
                                }
                            }
                        };
                        setPlans(prev => [queuedItem, ...prev.filter(p => p.id !== createdId)]);
                    }
                    setInfo(createdId
                        ? ("Submitted successfully. Order #" + createdId + " queued.")
                        : "Submitted successfully.");
                    await fetchPlans(true);
                } catch (err) {
                    setError(err.message || "Submit failed");
                } finally {
                    setPendingCreates(prev => Math.max(0, prev - 1));
                }
            })();
        }

        async function handleView(id) {
            setViewing(true);
            setError("");
            try {
                const res = await fetch(ORDERS_BASE + "/" + id);
                if (!res.ok) {
                    throw new Error("Failed to load plan content");
                }
                const data = await res.json();
                setModalPlan(data);
            } catch (e) {
                setError(e.message || "Failed to load plan content");
            } finally {
                setViewing(false);
            }
        }

        function handleDownload(plan) {
            const content = plan.generatedPlan || "";
            if (!content) {
                setError("No generated content to download.");
                return;
            }
            const caseInfo = plan.caseInfo || {};
            const client = caseInfo.client || {};
            const filename = "caseplan_" + (caseInfo.caseNumber || plan.id || "unknown") + "_" + (client.lastName || "client") + ".md";
            const blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        const hasActive = useMemo(() => plans.some(p => p.status === "pending" || p.status === "processing"), [plans]);

        return (
            <div className="page">
                <section className="panel">
                    <h1 className="panel-title">Case Plan Intake</h1>
                    {error && <div className="msg error">{error}</div>}
                    {info && <div className="msg info">{info}</div>}
                    <form onSubmit={handleSubmit}>
                        <div className="form-grid">
                            <Field label="Client First Name *" value={form.clientFirstName} onChange={v => updateField("clientFirstName", v)} />
                            <Field label="Client Last Name *" value={form.clientLastName} onChange={v => updateField("clientLastName", v)} />
                            <Field label="Client ID Number" value={form.clientIdNumber} onChange={v => updateField("clientIdNumber", v)} />
                            <Field label="Attorney Name *" value={form.attorneyName} onChange={v => updateField("attorneyName", v)} />
                            <Field label="Bar Number * (e.g. BAR-1234)" value={form.barNumber} onChange={v => updateField("barNumber", v)} placeholder="BAR-XXXX" />
                            <Field label="Referring Source" value={form.referringSource} onChange={v => updateField("referringSource", v)} />
                            <Field label="Case Number (Optional)" value={form.caseNumber} onChange={v => updateField("caseNumber", v)} />
                            <Field label="Primary Cause of Action *" value={form.primaryCauseOfAction} onChange={v => updateField("primaryCauseOfAction", v)} />
                            <Field label="Opposing Party" value={form.opposingParty} onChange={v => updateField("opposingParty", v)} extraClass="full" />
                            <Field label="Remedy Sought *" value={form.remedySought} onChange={v => updateField("remedySought", v)} extraClass="full" />
                            <Field label="Additional Causes" value={form.additionalCauses} onChange={v => updateField("additionalCauses", v)} />
                            <Field label="Prior Legal Actions" value={form.priorLegalActions} onChange={v => updateField("priorLegalActions", v)} />
                            <TextAreaField label="Case Documents / Notes" value={form.caseDocuments} onChange={v => updateField("caseDocuments", v)} extraClass="full" />
                        </div>
                        <div className="toolbar">
                            <button className="btn" type="submit">
                                {pendingCreates > 0 ? ("Submit Case (" + pendingCreates + " in flight)") : "Submit Case"}
                            </button>
                        </div>
                    </form>
                </section>

                <section className="panel">
                    <div className="top-row">
                        <h2 className="panel-title">Case Results</h2>
                        <div className="toolbar" style={{ marginTop: 0 }}>
                            <span className="hint">Auto refresh: every {POLL_MS / 1000}s {hasActive ? "(active queue)" : ""}</span>
                            <button className="btn btn-secondary" onClick={() => fetchPlans(false)} disabled={loading}>Refresh</button>
                        </div>
                    </div>
                    {loading ? (
                        <div className="empty">Loading entries...</div>
                    ) : plans.length === 0 ? (
                        <div className="empty">No entries yet.</div>
                    ) : (
                        <div className="table-wrap">
                            <table>
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Case</th>
                                    <th>Cause</th>
                                    <th>Attorney</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                {plans.map(plan => {
                                    const caseInfo = plan.caseInfo || {};
                                    const client = caseInfo.client || {};
                                    const attorney = caseInfo.attorney || {};
                                    const isCompleted = plan.status === "completed";
                                    const isFailed = plan.status === "failed";
                                    return (
                                        <tr key={plan.id}>
                                            <td>{plan.id}</td>
                                            <td>
                                                <div>{client.firstName || ""} {client.lastName || ""}</div>
                                                <div className="hint">Case #{caseInfo.caseNumber || "-"}</div>
                                            </td>
                                            <td>{caseInfo.primaryCauseOfAction || "-"}</td>
                                            <td>
                                                <div>{attorney.name || "-"}</div>
                                                <div className="hint">{attorney.barNumber || ""}</div>
                                            </td>
                                            <td>
                                                <span className={"status " + (plan.status || "pending")}>{plan.status || "pending"}</span>
                                                {isFailed && <div className="hint" style={{ marginTop: 6, color: "var(--danger)" }}>{plan.errorMessage || "Processing failed"}</div>}
                                            </td>
                                            <td>{formatDateTime(plan.createdAt)}</td>
                                            <td>
                                                <div className="row-actions">
                                                    {isCompleted && (
                                                        <>
                                                            <button className="btn btn-secondary" onClick={() => handleView(plan.id)} disabled={viewing}>
                                                                {viewing ? "Loading..." : "View"}
                                                            </button>
                                                            <button className="btn btn-secondary" onClick={() => handleDownload(plan)}>Download .md</button>
                                                        </>
                                                    )}
                                                    {!isCompleted && <span className="hint">No actions</span>}
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </section>

                {modalPlan && (
                    <div className="modal-backdrop" onClick={() => setModalPlan(null)}>
                        <div className="modal" onClick={(e) => e.stopPropagation()}>
                            <div className="modal-header">
                                <h3 className="modal-title">
                                    Case Plan Detail #{modalPlan.id}
                                </h3>
                                <div className="row-actions">
                                    <button className="btn btn-secondary" onClick={() => handleDownload(modalPlan)}>Download .md</button>
                                    <button className="btn btn-danger" onClick={() => setModalPlan(null)}>Close</button>
                                </div>
                            </div>
                            <div className="modal-body">
                                <pre>{modalPlan.generatedPlan || "No content available."}</pre>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        );
    }

    function Field({ label, value, onChange, extraClass, placeholder }) {
        return (
            <div className={extraClass || ""}>
                <label>{label}</label>
                <input value={value} placeholder={placeholder || ""} onChange={e => onChange(e.target.value)} />
            </div>
        );
    }

    function TextAreaField({ label, value, onChange, extraClass }) {
        return (
            <div className={extraClass || ""}>
                <label>{label}</label>
                <textarea value={value} onChange={e => onChange(e.target.value)} />
            </div>
        );
    }

    function formatDateTime(value) {
        if (!value) {
            return "-";
        }
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return value;
        }
        return date.toLocaleString();
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
